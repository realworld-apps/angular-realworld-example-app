trigger:
- main

resources:
- repo: self

variables:
  # ‡∏ä‡∏∑‡πà‡∏≠ Image ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á (‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô username ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  imageRepository: 'mccoycommy/angular-realworld' 
  containerRegistry: 'docker-hub-connection-v2' # ‡∏ä‡∏∑‡πà‡∏≠ connection ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô Step 3.1
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

  # VM Image ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏±‡∏ô Pipeline (Ubuntu)
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: 'MyMacAgent' # ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Pool ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
      # vmImage: $(vmImageName)
    steps:
    # Prepare Analysis
    # - task: SonarQubePrepare@8
      #displayName: 'Prepare SonarQube Analysis'
      #inputs:
        #SonarQube: 'sonarqube-local' # ‡∏ä‡∏∑‡πà‡∏≠ Service Connection
        #scannerMode: 'CLI' # ‡πÉ‡∏ä‡πâ CLI ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ build ‡∏î‡πâ‡∏ß‡∏¢ MSBuild/Maven
        #configMode: 'manual'
        #cliProjectKey: 'Angular-Realworld' # Project Key ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
        #cliProjectName: 'Angular-Realword'
        #cliSources: '.' # Scan ‡∏ó‡∏±‡πâ‡∏á Folder # sonar.exclusion ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ
        #extraProperties: |
          #sonar.exclusion=**/node_modules/**,**/dist/**,**/*.spec.ts
          #sonar.typescript.lcov.reportPaths=coverage/lcov.info
          # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Branch Analysis
          #sonar.branch.name=
    # Run SonarQube Scanner (Manual Way)
    - script: |
        sonar-scanner \
          -Dsonar.projectKey=Angular-Realworld \
          -Dsonar.sources=. \
          -Dsonar.host.url=http://localhost:9000 \
          -Dsonar.login=sqa_269773f1d9ef5859bb7df3c7afa4c5f7bb7908a5 \
          -Dsonar.exclusions=**/node_modules/**,**/dist/**
      displayName: 'Run SonarQube Analysis (Manual)'
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(containerRegistry)
        tags: |
          $(tag)
          latest

    # Check whether there is trivy on OS or not.
    - script: |
        if ! command -v trivy &> /dev/null; then
          brew install trivy
        fi

    # 2. ‡∏™‡πÅ‡∏Å‡∏ô Image
    - script: |
        trivy image --exit-code 0 --severity HIGH,CRITICAL $(imageRepository):$(tag)
      displayName: 'Scan Image with Trivy'

    # 3. Run Analysis (‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å Docker Build ‡∏´‡∏£‡∏∑‡∏≠ Trivy)
    # ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ñ‡∏ß‡∏£‡∏ß‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á Build Code ‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏Å‡πà‡∏≠‡∏ô Build Docker 
    # ‡πÅ‡∏ï‡πà‡πÉ‡∏ô Lab ‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤ Build ‡πÉ‡∏ô Docker ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Source Code ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ node_modules
    # SonarQube ‡∏™‡πÅ‡∏Å‡∏ô Code ‡∏î‡∏¥‡∏ö‡πÜ ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    - task: SonarQubeAnalyze@8
      displayName: 'Run SonarQube Analysis'
      inputs:
        jdkversion: 'JAVA_HOME_17_X64' # Sonar Scanner ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Java 17

# 4. Publish Result (‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏•‡∏±‡∏ö Azure DevOps)
    - task: SonarQubePublish@8
      displayName: 'Publish Quality Gate Result'
      inputs:
        pollingTimeoutSec: '300'

- stage: Deploy
  displayName: Deploy to Production
  dependsOn: Build    # ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Build ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
  condition: succeeded()
  jobs:
  - deployment: DeployWeb
    displayName: Deploy Web App
    environment: 'Production' # ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
    pool:
      name: 'MyMacAgent'
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo "üöÄ Deploying to Production Server..."
            displayName: 'Simulate Deployment'