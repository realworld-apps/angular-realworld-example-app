trigger:
- main

resources:
- repo: self

variables:
  # ‡∏ä‡∏∑‡πà‡∏≠ Image ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á (‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô username ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  imageRepository: 'mccoycommy/angular-realworld' 
  containerRegistry: 'docker-hub-connection-v2' # ‡∏ä‡∏∑‡πà‡∏≠ connection ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô Step 3.1
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

  # VM Image ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏±‡∏ô Pipeline (Ubuntu)
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: 'MyMacAgent' # ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Pool ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
      # vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(containerRegistry)
        tags: |
          $(tag)
          latest

    # Check whether there is trivy on OS or not.
    - script: |
        if ! command -v trivy &> /dev/null; then
          brew install trivy
        fi

    # 2. ‡∏™‡πÅ‡∏Å‡∏ô Image
    - script: |
        trivy image --exit-code 0 --severity HIGH,CRITICAL $(imageRepository):$(tag)
      displayName: 'Scan Image with Trivy'

- stage: Deploy
  displayName: Deploy to Production
  dependsOn: Build    # ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Build ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
  condition: succeeded()
  jobs:
  - deployment: DeployWeb
    displayName: Deploy Web App
    environment: 'Production' # ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
    pool:
      name: 'MyMacAgent'
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo "üöÄ Deploying to Production Server..."
            displayName: 'Simulate Deployment'